<!DOCTYPE html>
<html lang="th">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>The Genius: Ultimate Warp</title>
    
    <script src="https://cdn.jsdelivr.net/npm/onnxruntime-web/dist/ort.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Orbitron:wght@500;700&family=Bangers&family=Prompt:wght@300;500;700&display=swap" rel="stylesheet">
    
    <style>
        body { background: #000; margin: 0; overflow: hidden; touch-action: none; font-family: 'Prompt', sans-serif; }
        #stage { position: relative; width: 100vw; height: 100vh; display: flex; justify-content: center; align-items: center; background: #000; }
        video, canvas { position: absolute; max-width: 100%; max-height: 100%; object-fit: contain; }

        /* === ANIMATION STYLES === */
        .vanish { opacity: 0 !important; pointer-events: none; transition: opacity 0.2s ease; }

        /* ‡∏´‡∏°‡∏∏‡∏ô‡πÅ‡∏•‡∏∞‡∏Ç‡∏¢‡∏≤‡∏¢‡πÅ‡∏ö‡∏ö‡∏£‡∏ß‡∏î‡πÄ‡∏£‡πá‡∏ß (Warp) */
        .warp-speed {
            animation: warpAnim 2.0s cubic-bezier(0.7, 0, 0.3, 1) forwards;
        }

        @keyframes warpAnim {
            0% { transform: scale(1) rotate(0deg); opacity: 1; border-color: #00FFFF; }
            40% { transform: scale(1.5) rotate(180deg); opacity: 1; border-color: #FF0000; box-shadow: 0 0 50px #FF0000; }
            80% { transform: scale(10) rotate(720deg); opacity: 0.8; letter-spacing: 20px; filter: blur(2px); border-color: #FFFFFF;}
            100% { transform: scale(100); opacity: 0; }
        }

        /* ‡πÅ‡∏™‡∏á‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î‡∏ï‡∏≠‡∏ô‡∏à‡∏ö */
        .flash-bang {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: white; z-index: 100;
            pointer-events: none;
            animation: flashAnim 0.8s ease-out forwards;
        }
        @keyframes flashAnim { 0% { opacity: 1; } 100% { opacity: 0; } }

        /* UI ELEMENTS */
        .hidden { display: none !important; }
        .ui-box { background: rgba(0, 20, 30, 0.85); border: 1px solid #00FFFF; border-radius: 4px; box-shadow: 0 0 10px rgba(0,255,255,0.2); }
        .ui-overlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 10; }
        .pointer-auto { pointer-events: auto; }
        
        /* THEMES */
        body.theme-ironman .text-accent { color: #00FFFF; text-shadow: 0 0 5px #00FFFF; font-family: 'Orbitron', sans-serif; }
        body.theme-ben10 .ui-box { border-color: #00FF00; }
        body.theme-ben10 .text-accent { color: #00FF00; font-family: 'Bangers', cursive; }
        body.theme-barbie .ui-box { border-color: #fff; background: rgba(255, 255, 255, 0.4); }
        body.theme-barbie .text-accent { color: #FF1493; font-weight: 700; }
    </style>
</head>
<body class="theme-ironman">

    <div id="start-screen" class="fixed inset-0 z-50 flex flex-col items-center justify-center bg-gray-900 text-white pointer-events-auto transition-colors duration-300">
        
        <div id="logo-container" class="relative w-48 h-48 flex items-center justify-center z-20 transition-transform duration-1000">
            <div class="absolute inset-0 rounded-full border-4 border-cyan-500/30 animate-ping"></div>
            <div class="absolute inset-0 rounded-full border-[6px] border-cyan-400 flex items-center justify-center bg-gray-800 shadow-[0_0_50px_#00FFFF]">
                <div class="text-center transition-all duration-500">
                    <div class="text-xs text-cyan-200 tracking-widest">THE GENIUS</div>
                    <div class="text-xl font-bold font-[Orbitron] text-cyan-400 leading-tight">ULTIMATE<br>EDITION</div>
                </div>
            </div>
        </div>
        
        <div id="controls-container" class="w-64 space-y-4 mt-10 transition-opacity duration-300">
            <button id="start-btn" disabled class="w-full py-4 bg-gray-600 rounded-lg font-bold transition text-lg opacity-50 cursor-not-allowed">
                ‡∏£‡∏≠‡πÇ‡∏´‡∏•‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á...
            </button>
            <p id="loading-txt" class="text-center text-cyan-300 text-xs animate-pulse">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏°‡∏≠‡∏á‡∏Å‡∏•...</p>
            <div class="bg-red-900/50 p-2 rounded border border-red-500/30 text-center">
                <p class="text-[10px] text-red-200">‚ö†Ô∏è iPhone: ‡πÄ‡∏õ‡∏¥‡∏î‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡πÉ‡∏´‡πâ‡∏™‡∏∏‡∏î</p>
            </div>
        </div>
    </div>

    <div id="flash-layer" class="hidden"></div>

    <div id="stage" class="hidden">
        <video id="webcam" autoplay playsinline muted></video>
        <canvas id="overlay"></canvas>
    </div>

    <div id="hud" class="ui-overlay hidden">
        <div class="absolute top-4 left-4 pointer-auto">
            <div class="ui-box p-3 min-w-[140px]">
                <div class="flex justify-between items-center mb-2 border-b border-white/20 pb-1">
                    <span class="text-[10px] text-accent font-bold tracking-widest">DETECTED</span>
                    <div class="w-2 h-2 rounded-full bg-green-400 animate-pulse"></div>
                </div>
                <ul id="list" class="text-sm text-white font-[Prompt] max-h-[120px] overflow-y-auto">
                    <li class="opacity-50 text-xs">Scanning...</li>
                </ul>
            </div>
        </div>

        <div class="absolute bottom-6 w-full px-4 flex flex-col gap-3 pointer-auto">
            <div class="flex gap-2">
                <div class="ui-box flex-1 px-3 py-2 flex items-center">
                    <span class="text-[10px] text-accent mr-2">FILTER:</span>
                    <select id="filter-select" class="bg-transparent text-white text-sm w-full outline-none text-right font-[Prompt]"><option value="all">üëÅÔ∏è ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î</option></select>
                </div>
                <div class="ui-box px-3 py-2 flex items-center">
                    <span class="text-[10px] text-accent mr-2">THEME:</span>
                    <select id="theme-select" class="bg-transparent text-white text-sm outline-none font-[Prompt]">
                        <option value="theme-ironman">Iron Man</option>
                        <option value="theme-ben10">Ben 10</option>
                        <option value="theme-barbie">Barbie</option>
                    </select>
                </div>
            </div>

            <div class="grid grid-cols-3 gap-3">
                <button id="btn-lang" class="ui-box py-3 flex flex-col items-center justify-center active:scale-95 transition">
                    <span class="text-[8px] opacity-70 mb-1">LANG</span>
                    <span id="lang-txt" class="text-lg font-bold text-yellow-400">TH</span>
                </button>
                <button id="btn-audio" class="ui-box py-3 flex flex-col items-center justify-center active:scale-95 transition">
                    <span class="text-[8px] opacity-70 mb-1">AUDIO</span>
                    <span id="audio-txt" class="text-lg font-bold text-green-400">ON</span>
                </button>
                <button id="btn-cam" class="ui-box py-3 flex flex-col items-center justify-center active:scale-95 transition bg-white/10">
                    <span class="text-[8px] opacity-70 mb-1">SWITCH</span>
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15" /></svg>
                </button>
            </div>
        </div>
    </div>

    <script>
        const CLASSES = ["pen", "marker", "pencil", "notebook", "book", "scissors", "stapler", "computer monitor", "laptop", "mouse", "keyboard", "headphones", "glasses", "can", "soda can", "cup", "water bottle", "coffee mug", "plate", "bowl", "spoon", "fork", "keys", "wallet", "smartphone", "bag", "watch", "remote control", "fan", "chair", "lamp", "trash can"];
        const DICT = {'pen': {th:'‡∏õ‡∏≤‡∏Å‡∏Å‡∏≤', en:'Pen'}, 'marker': {th:'‡πÄ‡∏°‡∏à‡∏¥‡∏Å', en:'Marker'}, 'pencil': {th:'‡∏î‡∏¥‡∏ô‡∏™‡∏≠', en:'Pencil'}, 'notebook': {th:'‡∏™‡∏°‡∏∏‡∏î', en:'Notebook'}, 'book': {th:'‡∏´‡∏ô‡∏±‡∏á‡∏™‡∏∑‡∏≠', en:'Book'}, 'scissors': {th:'‡∏Å‡∏£‡∏£‡πÑ‡∏Å‡∏£', en:'Scissors'}, 'stapler': {th:'‡πÅ‡∏°‡πá‡∏Å', en:'Stapler'}, 'computer monitor': {th:'‡∏à‡∏≠‡∏Ñ‡∏≠‡∏°', en:'Monitor'}, 'laptop': {th:'‡πÇ‡∏ô‡πâ‡∏ï‡∏ö‡∏∏‡πä‡∏Å', en:'Laptop'}, 'mouse': {th:'‡πÄ‡∏°‡∏≤‡∏™‡πå', en:'Mouse'}, 'keyboard': {th:'‡∏Ñ‡∏µ‡∏¢‡πå‡∏ö‡∏≠‡∏£‡πå‡∏î', en:'Keyboard'}, 'headphones': {th:'‡∏´‡∏π‡∏ü‡∏±‡∏á', en:'Headphones'}, 'glasses': {th:'‡πÅ‡∏ß‡πà‡∏ô‡∏ï‡∏≤', en:'Glasses'}, 'can': {th:'‡∏Å‡∏£‡∏∞‡∏õ‡πã‡∏≠‡∏á', en:'Can'}, 'soda can': {th:'‡∏ô‡πâ‡∏≥‡∏≠‡∏±‡∏î‡∏•‡∏°', en:'Soda'}, 'cup': {th:'‡πÅ‡∏Å‡πâ‡∏ß', en:'Cup'}, 'water bottle': {th:'‡∏Ç‡∏ß‡∏î‡∏ô‡πâ‡∏≥', en:'Bottle'}, 'coffee mug': {th:'‡πÅ‡∏Å‡πâ‡∏ß‡∏Å‡∏≤‡πÅ‡∏ü', en:'Mug'}, 'plate': {th:'‡∏à‡∏≤‡∏ô', en:'Plate'}, 'bowl': {th:'‡∏ä‡∏≤‡∏°', en:'Bowl'}, 'spoon': {th:'‡∏ä‡πâ‡∏≠‡∏ô', en:'Spoon'}, 'fork': {th:'‡∏™‡πâ‡∏≠‡∏°', en:'Fork'}, 'keys': {th:'‡∏Å‡∏∏‡∏ç‡πÅ‡∏à', en:'Keys'}, 'wallet': {th:'‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤‡∏ï‡∏±‡∏á‡∏Ñ‡πå', en:'Wallet'}, 'smartphone': {th:'‡∏°‡∏∑‡∏≠‡∏ñ‡∏∑‡∏≠', en:'Phone'}, 'bag': {th:'‡∏Å‡∏£‡∏∞‡πÄ‡∏õ‡πã‡∏≤', en:'Bag'}, 'watch': {th:'‡∏ô‡∏≤‡∏¨‡∏¥‡∏Å‡∏≤', en:'Watch'}, 'remote control': {th:'‡∏£‡∏µ‡πÇ‡∏°‡∏ó', en:'Remote'}, 'fan': {th:'‡∏û‡∏±‡∏î‡∏•‡∏°', en:'Fan'}, 'chair': {th:'‡πÄ‡∏Å‡πâ‡∏≤‡∏≠‡∏µ‡πâ', en:'Chair'}, 'lamp': {th:'‡πÇ‡∏Ñ‡∏°‡πÑ‡∏ü', en:'Lamp'}, 'trash can': {th:'‡∏ñ‡∏±‡∏á‡∏Ç‡∏¢‡∏∞', en:'Trash'}};
        const MODEL_PATH = './yolov8s-worldv2.onnx';

        let session;
        let isMuted = false;
        let lang = 'th';
        let currentFilter = 'all';
        let lastSpoken = new Map();
        let synth = window.speechSynthesis;
        let voices = [];
        let videoDevices = [], deviceIdx = 0;
        let audioCtx; // For Sound FX

        const video = document.getElementById('webcam');
        const canvas = document.getElementById('overlay');
        const ctx = canvas.getContext('2d');
        const list = document.getElementById('list');
        const filterSelect = document.getElementById('filter-select');
        const startBtn = document.getElementById('start-btn');

        // ================= SCI-FI SOUND FX =================
        function playChargingSound() {
            if(!audioCtx) audioCtx = new (window.AudioContext || window.webkitAudioContext)();
            const osc = audioCtx.createOscillator();
            const gain = audioCtx.createGain();
            
            osc.connect(gain);
            gain.connect(audioCtx.destination);
            
            // ‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÄ‡∏™‡∏µ‡∏¢‡∏á ‡∏ß‡∏µ‡πä‡∏î‡∏î‡∏î‡∏î (Low to High Pitch)
            osc.type = 'lowpass';
            osc.frequency.setValueAtTime(100, audioCtx.currentTime);
            osc.frequency.exponentialRampToValueAtTime(150, audioCtx.currentTime + 1.5); // ‡∏Ç‡∏∂‡πâ‡∏ô‡∏™‡∏π‡∏á‡πÉ‡∏ô 1.5 ‡∏ß‡∏¥
            
            gain.gain.setValueAtTime(0.1, audioCtx.currentTime);
            gain.gain.linearRampToValueAtTime(0.5, audioCtx.currentTime + 1.0);
            gain.gain.exponentialRampToValueAtTime(0.01, audioCtx.currentTime + 1.5);

            osc.start();
            osc.stop(audioCtx.currentTime + 1.5);
        }

        // ================= VOICE SYSTEM =================
        function loadVoices() {
            voices = synth.getVoices();
            if(voices.length > 0) {
                startBtn.disabled = false;
                startBtn.classList.remove('bg-gray-600', 'opacity-50', 'cursor-not-allowed');
                startBtn.classList.add('bg-cyan-600', 'hover:bg-cyan-500');
                startBtn.textContent = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô";
                document.getElementById('loading-txt').classList.add('hidden');
            }
        }
        loadVoices();
        if (speechSynthesis.onvoiceschanged !== undefined) speechSynthesis.onvoiceschanged = loadVoices;
        setTimeout(() => { if(startBtn.disabled) { startBtn.disabled = false; startBtn.classList.add('bg-cyan-600'); startBtn.textContent = "‡πÄ‡∏£‡∏¥‡πà‡∏°‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô"; } }, 3000);

        function speak(text, rate = 1.0, pitch = 1.0, forceEnglish = false) {
            const u = new SpeechSynthesisUtterance(text);
            
            // ‡∏ñ‡πâ‡∏≤ Force English (‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏ï‡∏≠‡∏ô‡πÄ‡∏£‡∏¥‡πà‡∏°) ‡πÉ‡∏´‡πâ‡πÉ‡∏ä‡πâ‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏≠‡∏±‡∏á‡∏Å‡∏§‡∏©
            if (forceEnglish) {
                u.lang = 'en-US';
                const enVoice = voices.find(v => v.lang.includes('en') && v.name.includes('Google'));
                if(enVoice) u.voice = enVoice;
            } else {
                u.lang = lang === 'th' ? 'th-TH' : 'en-US';
                if(lang === 'th') { const v = voices.find(x => x.lang.includes('th')); if(v) u.voice = v; }
            }
            
            u.rate = rate; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡πÄ‡∏£‡πá‡∏ß
            u.pitch = pitch; // ‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡πà‡∏≥/‡∏™‡∏π‡∏á
            u.volume = 1.0;
            synth.speak(u);
        }

        // ================= UI EVENTS =================
        Object.keys(DICT).sort().forEach(k => {
            const opt = document.createElement('option'); opt.value = k; opt.textContent = `üîπ ${DICT[k].th}`; opt.classList.add('text-black');
            filterSelect.appendChild(opt);
        });
        filterSelect.addEventListener('change', (e) => currentFilter = e.target.value);
        document.getElementById('theme-select').addEventListener('change', (e) => document.body.className = e.target.value);
        document.getElementById('btn-lang').addEventListener('click', () => { lang = lang==='th'?'en':'th'; document.getElementById('lang-txt').textContent = lang.toUpperCase(); speak(lang==='th'?"‡∏†‡∏≤‡∏©‡∏≤‡πÑ‡∏ó‡∏¢":"English"); });
        document.getElementById('btn-audio').addEventListener('click', () => { isMuted=!isMuted; const t=document.getElementById('audio-txt'); t.textContent=isMuted?'OFF':'ON'; t.className=isMuted?'text-lg font-bold text-red-400':'text-lg font-bold text-green-400'; if(!isMuted) speak("On"); });

        // ================= START SEQUENCE (EDGY STYLE) =================
        startBtn.addEventListener('click', async () => {
            // 1. Voice 1: Initializing
            speak("Initializing Core Systems...", 1.3, 0.8, true); // ‡πÄ‡∏£‡πá‡∏ß+‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ï‡πà‡∏≥ = ‡πÄ‡∏ó‡πà
            
            // 2. ‡∏ã‡πà‡∏≠‡∏ô‡∏õ‡∏∏‡πà‡∏°
            document.getElementById('controls-container').classList.add('vanish');

            // 3. ‡πÄ‡∏£‡∏¥‡πà‡∏° Sound FX (‡πÄ‡∏™‡∏µ‡∏¢‡∏á‡∏ä‡∏≤‡∏£‡πå‡∏à)
            playChargingSound();

            try {
                // Load Camera & Model
                const stream = await navigator.mediaDevices.getUserMedia({ video: { facingMode: 'environment', width: { ideal: 1280 }, height: { ideal: 720 } } });
                video.srcObject = stream;
                await new Promise(r => video.onloadedmetadata = r);
                session = await ort.InferenceSession.create(MODEL_PATH, { executionProviders: ['wasm'] });

                // 4. ‡πÄ‡∏£‡∏¥‡πà‡∏°‡∏´‡∏°‡∏∏‡∏ô (Warp)
                const logo = document.getElementById('logo-container');
                logo.classList.add('warp-speed');

                // 5. Voice 2: Neural Link
                setTimeout(() => {
                    speak("Neural Link... Established.", 1.4, 0.7, true);
                }, 800);

                // 6. ‡∏£‡∏∞‡πÄ‡∏ö‡∏¥‡∏î‡∏ï‡∏π‡πâ‡∏° (Finish)
                setTimeout(() => {
                    // Voice 3: Online
                    speak("The Genius... Online.", 1.1, 0.6, true);

                    const flash = document.getElementById('flash-layer');
                    flash.classList.remove('hidden');
                    flash.classList.add('flash-bang');
                    document.getElementById('start-screen').classList.add('hidden');
                    document.getElementById('stage').classList.remove('hidden');
                    document.getElementById('hud').classList.remove('hidden');
                    detect();
                }, 1900);

            } catch (e) {
                document.getElementById('controls-container').classList.remove('vanish');
                alert("Error: " + e.message);
                location.reload();
            }
        });

        // ================= CORE AI =================
        async function detect() {
            const [input, sx, sy] = preprocess(video, 320, 320);
            const feeds = {}; feeds[session.inputNames[0]] = input;
            const res = await session.run(feeds);
            const output = res[session.outputNames[0]].data;
            const boxes = postprocess(output, sx, sy);
            draw(boxes);
            requestAnimationFrame(detect);
        }

        function preprocess(img, w, h) {
            const c = document.createElement('canvas'); c.width=w; c.height=h;
            const cx = c.getContext('2d'); cx.drawImage(img,0,0,w,h);
            const d = cx.getImageData(0,0,w,h).data;
            const f32 = new Float32Array(3*w*h);
            for(let i=0; i<w*h; i++) { f32[i]=d[i*4]/255.0; f32[i+w*h]=d[i*4+1]/255.0; f32[i+2*w*h]=d[i*4+2]/255.0; }
            return [new ort.Tensor("float32", f32, [1,3,h,w]), video.videoWidth/w, video.videoHeight/h];
        }

        function postprocess(data, sx, sy) {
            const nc = CLASSES.length; const na = data.length/(4+nc); const boxes=[];
            for(let i=0; i<na; i++) {
                let maxS=0, maxC=-1;
                for(let c=0; c<nc; c++) { const s=data[(4+c)*na+i]; if(s>maxS){maxS=s;maxC=c;} }
                if(maxS > 0.25) { const x=data[0*na+i], y=data[1*na+i], w=data[2*na+i], h=data[3*na+i]; boxes.push({x:(x-w/2)*sx, y:(y-h/2)*sy, w:w*sx, h:h*sy, s:maxS, c:maxC}); }
            }
            return nms(boxes);
        }

        function nms(boxes) {
            boxes.sort((a,b)=>b.s-a.s); const res=[];
            while(boxes.length) {
                const b = boxes[0]; res.push(b);
                boxes = boxes.filter(o => {
                    const xx1=Math.max(b.x,o.x), yy1=Math.max(b.y,o.y), xx2=Math.min(b.x+b.w,o.x+o.w), yy2=Math.min(b.y+b.h,o.y+o.h);
                    const int=Math.max(0,xx2-xx1)*Math.max(0,yy2-yy1);
                    return int/(b.w*b.h+o.w*o.h-int) < 0.45;
                });
            }
            return res;
        }

        function draw(boxes) {
            const stage = document.getElementById('stage');
            const scale = Math.min(stage.clientWidth/video.videoWidth, stage.clientHeight/video.videoHeight);
            canvas.width = video.videoWidth * scale;
            canvas.height = video.videoHeight * scale;
            ctx.clearRect(0,0,canvas.width,canvas.height);

            const found = new Set();
            const now = Date.now();
            const theme = document.body.className;
            let color='#00FFFF', font='16px Prompt';
            if(theme.includes('ben10')) { color='#00FF00'; font='bold 20px Bangers'; }
            if(theme.includes('barbie')) { color='#FF1493'; font='bold 16px Prompt'; }

            boxes.forEach(b => {
                const rawLabel = CLASSES[b.c];
                if(currentFilter!=='all' && rawLabel!==currentFilter) return;
                const labelObj = DICT[rawLabel] || {th:rawLabel, en:rawLabel};
                const labelTxt = lang === 'th' ? labelObj.th : labelObj.en;
                found.add(labelTxt);

                const x=b.x*scale, y=b.y*scale, w=b.w*scale, h=b.h*scale;
                ctx.lineWidth = 3; ctx.strokeStyle = color;
                if(theme.includes('ironman')) {
                    const c = Math.min(w,h)*0.2;
                    ctx.beginPath(); ctx.moveTo(x,y+c); ctx.lineTo(x,y); ctx.lineTo(x+c,y);
                    ctx.moveTo(x+w-c,y); ctx.lineTo(x+w,y); ctx.lineTo(x+w,y+c);
                    ctx.moveTo(x+w,y+h-c); ctx.lineTo(x+w,y+h); ctx.lineTo(x+w-c,y+h);
                    ctx.moveTo(x+c,y+h); ctx.lineTo(x,y+h); ctx.lineTo(x,y+h-c); ctx.stroke();
                } else if(theme.includes('ben10')) ctx.strokeRect(x,y,w,h);
                else { ctx.setLineDash([10,5]); ctx.strokeRect(x,y,w,h); ctx.setLineDash([]); }

                ctx.fillStyle = theme.includes('barbie')?'rgba(255,192,203,0.8)':'rgba(0,20,30,0.7)';
                const tw = ctx.measureText(labelTxt).width;
                ctx.fillRect(x,y-30,tw+20,25);
                ctx.fillStyle = color; ctx.font = font; ctx.fillText(labelTxt, x+10, y-12);

                if(!isMuted && (!lastSpoken.get(labelTxt) || now - lastSpoken.get(labelTxt) > 5000)) {
                    speak(labelTxt); lastSpoken.set(labelTxt, now);
                }
            });
            list.innerHTML = found.size ? [...found].map(t=>`<li>üîπ ${t}</li>`).join('') : '<li class="opacity-50 text-xs">Scanning...</li>';
        }

        document.getElementById('btn-cam').onclick = async()=>{
            const d = await navigator.mediaDevices.enumerateDevices();
            videoDevices = d.filter(x=>x.kind==='videoinput');
            if(videoDevices.length>1){
                deviceIdx=(deviceIdx+1)%videoDevices.length;
                video.srcObject = await navigator.mediaDevices.getUserMedia({video:{deviceId:{exact:videoDevices[deviceIdx].deviceId}}});
            }
        };
    </script>
</body>
</html>